#!/usr/bin/env node

/**
 * CLI for exporting markdown to PDF
 * @module @defra/delivery-info-arch-tooling/bin/export-pdf
 */

const fs = require('fs')
const path = require('path')
const { glob } = require('glob')

// Default patterns
const DEFAULT_PATTERNS = [
  'architecture/**/analysis/**/*.md',
  'architecture/roadmap/**/analysis/**/*.md'
]

// Parse arguments
const args = process.argv.slice(2)

async function main () {
  let files

  if (args.length > 0 && !args[0].startsWith('-')) {
    files = args.filter(a => !a.startsWith('-'))
  } else {
    const allFiles = []
    for (const pattern of DEFAULT_PATTERNS) {
      const matches = await glob(pattern, { cwd: process.cwd() })
      allFiles.push(...matches)
    }
    files = allFiles
  }

  if (files.length === 0) {
    console.log('No markdown files found to export')
    return
  }

  console.log(`Exporting ${files.length} file(s) to PDF...`)

  // Import PDF library
  let mdToPdf
  try {
    const mdToPdfModule = require('md-to-pdf')
    mdToPdf = mdToPdfModule.mdToPdf || mdToPdfModule.default || mdToPdfModule
  } catch (e) {
    console.error('Error: md-to-pdf package is required')
    console.error('Install with: npm install md-to-pdf')
    process.exit(1)
  }

  // Find CSS file if available
  const cssPath = path.join(__dirname, '..', 'lib', 'pdf', 'pdf-styles.css')
  const stylesheet = fs.existsSync(cssPath) ? [cssPath] : []

  // Create output directory
  const pdfOutputDir = path.join(process.cwd(), 'generated', 'pdf')
  if (!fs.existsSync(pdfOutputDir)) {
    fs.mkdirSync(pdfOutputDir, { recursive: true })
  }

  for (const file of files) {
    const inputPath = path.resolve(file)

    if (!fs.existsSync(inputPath)) {
      console.error(`❌ File not found: ${file}`)
      continue
    }

    const relativePath = path.relative(process.cwd(), inputPath)
    const outputPath = path.join(pdfOutputDir, relativePath.replace(/\.md$/, '.pdf'))

    const outputDir = path.dirname(outputPath)
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true })
    }

    try {
      // Configure PDF options
      const pdfOptions = {
        pdf_options: {
          format: 'A4',
          printBackground: true,
          margin: {
            top: '20mm',
            right: '15mm',
            bottom: '20mm',
            left: '15mm'
          }
        },
        stylesheet: stylesheet,
        body_class: 'markdown-body',
        marked_options: {
          breaks: true,
          gfm: true
        }
      }

      // Generate PDF
      const pdf = await mdToPdf({ path: inputPath }, pdfOptions)

      if (pdf) {
        fs.writeFileSync(outputPath, pdf.content)
        console.log(`✅ ${file} → ${path.relative(process.cwd(), outputPath)}`)
      } else {
        throw new Error('PDF generation returned null')
      }
    } catch (error) {
      console.error(`❌ Failed to export ${file}:`, error.message)
    }
  }

  console.log('\nDone!')
}

main().catch(console.error)

